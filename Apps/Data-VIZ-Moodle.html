<!DOCTYPE html>
<html lang="fr" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse Avancée des Activités LMS Moodle</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --bg-color: #f9fafb; --text-color: #1f2937; --card-bg: white; --border-color: #e5e7eb;
            --primary-color: #4a6cf7; --primary-hover-color: #3855d1; --table-header-bg: #f3f4f6;
            --table-row-even-bg: #f9fafb; --input-bg: white; --input-text: #1f2937; --input-border: #d1d5db;
            --hero-bg: #eef2ff; 
            --hero-text: var(--primary-color);
            --details-bg: #f9fafb; 
            --details-border: #e5e7eb; 
        }
        html.dark {
            --bg-color: #111827; --text-color: #f3f4f6; --card-bg: #1f2937; --border-color: #4b5563;
            --primary-color: #60a5fa; --primary-hover-color: #3b82f6; --table-header-bg: #374151;
            --table-row-even-bg: #1f2937; --input-bg: #374151; --input-text: #f3f4f6; --input-border: #4b5563;
            --hero-bg: #1e3a8a; 
            --hero-text: #93c5fd; 
            --details-bg: #374151; 
            --details-border: #4b5563; 
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: var(--text-color); background-color: var(--bg-color); line-height: 1.6; transition: background-color 0.3s, color 0.3s; }
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 24px; padding: 24px; transition: background-color 0.3s, border-color 0.3s; opacity: 0; animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        .chart-container { position: relative; height: 350px; width: 100%; margin-bottom: 30px; }
        .metric-card { background-color: var(--table-row-even-bg); border-left: 4px solid var(--primary-color); padding: 15px; margin-bottom: 15px; border-radius: 6px; transition: background-color 0.3s, border-left-color 0.3s; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid var(--border-color); padding: 10px 12px; text-align: left; font-size: 0.9em; transition: border-color 0.3s; }
        th { background-color: var(--table-header-bg); font-weight: 600; transition: background-color 0.3s; }
        tr:nth-child(even) { background-color: var(--table-row-even-bg); transition: background-color 0.3s; }
        .filter-input, .filter-select { padding: 8px 12px; border-radius: 4px; border: 1px solid var(--input-border); margin-right: 10px; background-color: var(--input-bg); color: var(--input-text); transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        .btn { padding: 10px 15px; border-radius: 6px; border: none; cursor: pointer; transition: background-color 0.2s, color 0.2s, transform 0.1s; font-weight: 500;}
        .btn:active { transform: translateY(1px); }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover-color); }
        .btn-secondary { background-color: #6c757d; color: white; }
        html.dark .btn-secondary { background-color: #4b5563; }
        .btn-secondary:hover { background-color: #5a6268; }
        html.dark .btn-secondary:hover { background-color: #374151; }
        .hidden { display: none; }
        #loadingIndicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0,0,0,0.8); color: white; padding: 25px 30px; border-radius: 8px; z-index: 1000; font-size: 1.2em; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .notification {
            position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 6px;
            color: white; font-weight: bold; z-index: 1001; min-width: 280px; max-width: 450px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.25);
            opacity: 0; transform: translateX(100%);
            animation: slideInNotification 0.5s forwards; 
            display: flex; justify-content: space-between; align-items: flex-start;
        }
        @keyframes slideInNotification { to { opacity: 1; transform: translateX(0); } }
        .notification-close { background: none; border: none; color: inherit; font-size: 1.5em; font-weight: bold; cursor: pointer; padding: 0 0 0 15px; line-height: 0.8; }
        .notification.success { background-color: #28a745; }
        .notification.error { background-color: #dc3545; }
        .notification.warning { background-color: #ffc107; color: #212529; }
        .notification.warning .notification-close { color: #212529; }
        #scrollToTopBtn {
            position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; border-radius: 50%;
            background-color: var(--primary-color); color: white; border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer; display: none; justify-content: center; align-items: center; font-size: 24px;
            z-index: 999; transition: opacity 0.3s, visibility 0.3s, background-color 0.3s;
        }
        #scrollToTopBtn:hover { background-color: var(--primary-hover-color); }
        #scrollToTopBtn.show { display: flex; opacity: 1; visibility: visible; }
        .hero-banner { background-color: var(--hero-bg); color: var(--hero-text); padding: 30px 20px; border-radius: 8px; margin-bottom: 30px; text-align: center; transition: background-color 0.3s, color 0.3s; }
        .hero-banner svg { width: 48px; height: 48px; margin: 0 auto 10px auto; fill: currentColor; }
        details > summary { list-style: none; } 
        details > summary::-webkit-details-marker { display: none; } 
        details > summary::before { content: '▶'; margin-right: 0.5em; display: inline-block; transition: transform 0.2s; font-size: 0.8em; color: var(--text-color); }
        details[open] > summary::before { transform: rotate(90deg); }
        
        /* Drag and Drop Area */
        #dropZone {
            border: 2px dashed var(--input-border);
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
            background-color: var(--card-bg);
        }
        #dropZone.dragover {
            border-color: var(--primary-color);
            background-color: var(--hero-bg);
        }
        #dropZone p {
            color: var(--text-color);
            font-size: 1.1em;
            margin-bottom: 10px;
        }
    </style>
</head>
<body class="p-5">
    <div id="loadingIndicator" class="hidden">Analyse en cours...</div>
    <div id="notificationArea"></div>

    <div class="container mx-auto max-w-6xl">
        <header class="text-center mb-10 pt-5">
            <div class="flex justify-end mb-4 px-4 md:px-0">
                <button id="themeToggleBtn" class="btn btn-secondary text-sm py-1 px-3">Mode Sombre/Clair</button>
            </div>
            <h1 class="text-4xl font-bold mb-2">Analyse Avancée des Activités LMS Moodle</h1>
            <p class="text-gray-500 dark:text-gray-300" id="reportPeriod">Chargez un fichier CSV pour commencer l'analyse.</p>
        </header>

        <section class="hero-banner">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-12 h-12 mx-auto mb-2"><path fill-rule="evenodd" d="M2.25 2.25a.75.75 0 000 1.5H3v10.5a3 3 0 003 3h1.21l-1.172 3.513a.75.75 0 001.424.475L8.998 18h6.004l1.501 4.504a.75.75 0 001.424-.475L16.79 18h1.21a3 3 0 003-3V3.75h.75a.75.75 0 000-1.5H2.25zM6 6a.75.75 0 01.75-.75h10.5a.75.75 0 010 1.5H6.75A.75.75 0 016 6zm0 3.75A.75.75 0 016.75 9h10.5a.75.75 0 010 1.5H6.75A.75.75 0 016 9.75zm0 3.75A.75.75 0 016.75 13.5h10.5a.75.75 0 010 1.5H6.75A.75.75 0 016 13.5z" clip-rule="evenodd" /></svg>
            <h2 class="text-2xl font-semibold">Un suivi pour mieux accompagner vos apprenants !</h2>
        </section>

        <section class="card mb-8">
            <h2 class="text-2xl font-bold mb-4">1. Charger les données</h2>
            <div id="dropZone">
                <p>Glissez-déposez votre fichier CSV ici</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">ou</p>
                <button type="button" onclick="document.getElementById('csvFile').click()" class="btn btn-primary mt-2">Sélectionner un fichier</button>
                <input type="file" id="csvFile" accept=".csv" class="hidden">
            </div>
        </section>

        <section id="filterSection" class="card mb-8 hidden">
             <div class="flex justify-between items-center mb-4">
                 <h2 class="text-2xl font-bold">2. Filtrer les données</h2>
                 <div class="flex items-center space-x-2">
                    <button id="exportPdfButton" class="btn btn-secondary text-sm py-1 px-3">Exporter en PDF</button>
                    <button id="exportJsonButton" class="btn btn-secondary text-sm py-1 px-3">Exporter en JSON</button>
                    <button id="resetFiltersButton" class="btn btn-secondary text-sm py-1 px-3">Réinitialiser</button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-medium mb-1">Mois :</label>
                    <div id="monthFilterContainer" class="mt-1 filter-checkbox-container"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Cours :</label> 
                    <div id="courseFilterContainer" class="mt-1 filter-checkbox-container"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Apprenant :</label>
                    <div id="learnerFilterContainer" class="mt-1 filter-checkbox-container"></div>
                </div>
            </div>
        </section>

        <div id="reportContent" class="hidden">
            <section class="card mb-8">
                <h2 class="text-2xl font-bold mb-4">Résumé exécutif</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="metric-card"><h3 class="text-lg font-semibold">Nb. total d'événements</h3><p class="text-3xl font-bold" id="totalEvents">0</p></div>
                    <div class="metric-card"><h3 class="text-lg font-semibold">Utilisateurs actifs</h3><p class="text-3xl font-bold" id="activeUsers">0</p></div>
                    <div class="metric-card"><h3 class="text-lg font-semibold">Durée moy. session</h3><p class="text-3xl font-bold" id="avgSessionDuration">0 min</p></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="metric-card"><h3 class="text-lg font-semibold">Heure de pointe</h3><p class="text-3xl font-bold" id="peakHour">N/A</p></div>
                    <div class="metric-card"><h3 class="text-lg font-semibold">Jour le plus actif</h3><p class="text-3xl font-bold" id="peakDay">N/A</p></div>
                    <div class="metric-card"><h3 class="text-lg font-semibold">Cours le plus actif</h3><p class="text-2xl font-bold" id="mostActiveCourse">N/A</p></div>
                </div>
            </section>
            <section class="card">
                <h2 class="text-2xl font-bold mb-6">Analyse de l'activité par utilisateur</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div><h3 class="text-xl font-semibold mb-4">Nombre d'événements par utilisateur</h3><div class="chart-container"><canvas id="userActivityChart"></canvas></div></div>
                    <div><h3 class="text-xl font-semibold mb-4">Temps total passé (min)</h3><div class="chart-container"><canvas id="totalTimeChart"></canvas></div></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-4">Score d'engagement par utilisateur</h3>
                        <div class="chart-container"><canvas id="engagementScoreChart"></canvas></div>
                        <details class="mt-2 text-sm p-3 rounded-md shadow-sm border"><summary class="font-semibold cursor-pointer">Comment est calculé le score ?</summary><div class="mt-2 pl-4 pt-2 border-l-2"><p>Ce score (0-1) évalue l'implication d'un utilisateur via :</p><ul class="list-disc pl-5 mt-1 text-xs space-y-1"><li>Volume d'activité</li><li>Régularité (jours uniques)</li><li>Temps passé</li><li>Diversité des actions</li></ul></div></details>
                    </div>
                    <div><h3 class="text-xl font-semibold mb-4">Distribution des durées de session (Médiane)</h3><div class="chart-container"><canvas id="sessionDurationChart"></canvas></div></div>
                </div>
                <h3 class="text-xl font-semibold mb-4">Statistiques des sessions par utilisateur</h3>
                <div class="overflow-x-auto"><table id="userSessionStatsTable"><thead><tr><th>Utilisateur</th><th>Nb Sessions</th><th>Moy. (min)</th><th>Méd. (min)</th><th>Total (min)</th><th>Total (heures)</th><th>Min (min)</th><th>Max (min)</th></tr></thead><tbody></tbody></table></div>
            </section>
            <section class="card mt-8">
                <h2 class="text-2xl font-bold mb-6">Analyse des Composants et Contenus</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div><h3 class="text-xl font-semibold mb-4">Événements par type de composant</h3><div class="chart-container"><canvas id="componentChart"></canvas></div></div>
                    <div><h3 class="text-xl font-semibold mb-4">Événements par cours</h3><div class="chart-container"><canvas id="courseActivityChart"></canvas></div></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div><h3 class="text-xl font-semibold mb-4">Temps total passé par cours (min)</h3><div class="chart-container"><canvas id="courseTimeChart"></canvas></div></div>
                    <div><h3 class="text-xl font-semibold mb-4">Durée moyenne des sessions par cours</h3><div class="chart-container"><canvas id="courseAvgSessionChart"></canvas></div></div>
                </div>
            </section>
            <section class="card mt-8">
                <h2 class="text-2xl font-bold mb-6">Analyse des tendances temporelles</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div><h3 class="text-xl font-semibold mb-4">Activité par jour de la semaine</h3><div class="chart-container"><canvas id="weekdayActivityChart"></canvas></div></div>
                    <div><h3 class="text-xl font-semibold mb-4">Activité par heure de la journée</h3><div class="chart-container"><canvas id="hourlyActivityChart"></canvas></div></div>
                </div>
                <div id="monthlyTimeChartContainer" class="hidden">
                    <h3 class="text-xl font-semibold mb-4">Évolution du Temps de Connexion par Mois</h3>
                    <div class="chart-container"><canvas id="monthlyTimeChart"></canvas></div>
                </div>
            </section>
            <section class="card mt-8" id="insightsSection">
                <h2 class="text-2xl font-bold mb-6">Insights et recommandations</h2>
                <div id="unparsableDatesWarningArea" class="mb-4"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><h3 class="text-xl font-semibold mb-3">Principaux constats</h3><ul class="list-disc pl-5 space-y-2" id="mainInsightsList"></ul></div>
                    <div><h3 class="text-xl font-semibold mb-3">Recommandations</h3><ul class="list-disc pl-5 space-y-2" id="recommendationsList"></ul></div>
                </div>
            </section>
        </div> 

        <button id="scrollToTopBtn" title="Retour en haut">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" /></svg>
        </button>

        <footer class="text-center py-8 mt-10 border-t">
            <p class="text-sm text-gray-500" id="reportGeneratedDate">Prêt à analyser.</p>
            <p class="text-sm text-gray-500 mt-1">Desmond de Amil - IRP 2025</p>
        </footer>
    </div>

    <script>
        // --- CHART INSTANCES & GLOBAL VARS ---
        let userActivityChartInstance, totalTimeChartInstance, engagementScoreChartInstance, sessionDurationChartInstance;
        let courseActivityChartInstance, courseTimeChartInstance, courseAvgSessionChartInstance, componentChartInstance;
        let weekdayActivityChartInstance, hourlyActivityChartInstance, monthlyTimeChartInstance;
        let allUploadedData = []; 
        let currentFilteredData = [];
        let currentFileName = "";
        const frenchMonths = ["janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", "septembre", "octobre", "novembre", "décembre"];

        // --- UTILITY FUNCTIONS ---
        function getColors(n, opacity = 0.7) { 
            const baseColors = ['54, 162, 235', '255, 99, 132', '75, 192, 192', '255, 159, 64', '153, 102, 255', '255, 205, 86', '201, 203, 207'];
            let colors = []; for (let i = 0; i < n; i++) colors.push(`rgba(${baseColors[i % baseColors.length]}, ${opacity})`); return colors;
        }

        function getEngagementColor(score) {
            const r = Math.round(255 * (1 - score));
            const g = Math.round(255 * score);
            return `rgba(${r}, ${g}, 0, 0.7)`;
        }
        
        function parseFrenchDate(dateString) { 
            if (!dateString || typeof dateString !== 'string') return null;
            const monthMap = {
                'janv':0,  'janvier':0,  'janv.':0, 'févr':1,  'fev':1,    'février':1, 'fév.':1, 'mars':2, 'avr':3,   'avril':3,   'avr.':3, 'mai':4, 'juin':5, 'juil':6,  'juill':6, 'juillet':6, 'juill.':6, 'août':7,  'aout':7,    'août.':7, 'sept':8,  'septembre':8,'sept.':8, 'oct':9,   'octobre':9, 'oct.':9, 'nov':10,  'novembre':10,'nov.':10, 'déc':11,  'décembre':11,'déc.':11
            };
            const parts = dateString.match(/(\d{1,2})\s([a-zA-Zûéàâêîôäëïöüçÿ]+)(\.?)\s(\d{2}),\s(\d{2}):(\d{2}):(\d{2})/i);
            if (!parts) return null;
            const day = parseInt(parts[1],10), monthStr = parts[2].toLowerCase(), month = monthMap[monthStr], year = parseInt(parts[4],10)+2000, hours = parseInt(parts[5],10), minutes = parseInt(parts[6],10), seconds = parseInt(parts[7],10);
            if (month === undefined || [day,month,year,hours,minutes,seconds].some(isNaN)) return null;
            return new Date(year,month,day,hours,minutes,seconds);
        }

        function destroyAllCharts() {
            [userActivityChartInstance, totalTimeChartInstance, engagementScoreChartInstance, sessionDurationChartInstance, courseActivityChartInstance, courseTimeChartInstance, courseAvgSessionChartInstance, componentChartInstance, weekdayActivityChartInstance, hourlyActivityChartInstance, monthlyTimeChartInstance].forEach(instance => {
                if(instance) instance.destroy();
            });
        }
        
        function showNotification(message, type = 'success', autoDismiss = true) {
            const notificationArea = document.getElementById('notificationArea');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<span>${message}</span><button class="notification-close">&times;</button>`;
            notificationArea.appendChild(notification);
            notification.querySelector('.notification-close').onclick = () => notification.remove();
            if (autoDismiss) setTimeout(() => notification.remove(), 7000);
        }

        function truncateLabel(label, maxLength = 25) {
            if (label.length > maxLength) {
                return label.substring(0, maxLength) + '...';
            }
            return label;
        }

        function renderReport(reportData) { 
            destroyAllCharts();
            document.getElementById('reportContent').classList.remove('hidden');

            const summaryIds = { totalEvents: '0', activeUsers: '0', avgSessionDuration: '0 min', peakHour: 'N/A', peakDay: 'N/A', mostActiveCourse: 'N/A' };
            Object.keys(summaryIds).forEach(id => { document.getElementById(id).textContent = reportData.summary?.[id] || summaryIds[id]; });
            
            const unparsableWarningArea = document.getElementById('unparsableDatesWarningArea');
            if (reportData.summary?.unparsableDatesWarning) {
                unparsableWarningArea.innerHTML = `<p class="p-3 bg-yellow-100 dark:bg-yellow-800 border-l-4 border-yellow-500 text-yellow-800 dark:text-yellow-200 rounded">${reportData.summary.unparsableDatesWarning}</p>`;
                unparsableWarningArea.classList.remove('hidden');
            } else {
                unparsableWarningArea.classList.add('hidden');
            }

            const insightsLists = { mainInsights: 'mainInsightsList', recommendations: 'recommendationsList' };
            for (const key in insightsLists) {
                const listElem = document.getElementById(insightsLists[key]);
                listElem.innerHTML = ''; 
                (reportData.insights?.[key] || []).forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = item;
                    listElem.appendChild(li);
                });
            }

            if(reportData.userNames?.length > 0) {
                userActivityChartInstance = new Chart(document.getElementById('userActivityChart'), {type:'bar',data:{labels:reportData.userNames, datasets:[{label:'Événements',data:reportData.eventCounts,backgroundColor:getColors(reportData.userNames.length)}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
                totalTimeChartInstance = new Chart(document.getElementById('totalTimeChart'), {type:'bar',data:{labels:reportData.userNames, datasets:[{label:'Temps (min)',data:reportData.totalTimes,backgroundColor:getColors(reportData.userNames.length)}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
                engagementScoreChartInstance = new Chart(document.getElementById('engagementScoreChart'), {type:'bar',data:{labels:reportData.userNames, datasets:[{label:'Score',data:reportData.engagementScores,backgroundColor:reportData.engagementScores.map(score => getEngagementColor(score))}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:1}}}});
                sessionDurationChartInstance = new Chart(document.getElementById('sessionDurationChart'), {type:'bar',data:{labels:Object.keys(reportData.sessionData),datasets:[{label:'Médiane (min)',data:Object.values(reportData.sessionData).map(d=>d.median),backgroundColor:getColors(Object.keys(reportData.sessionData).length)}]},options:{responsive:true,maintainAspectRatio:false,plugins:{tooltip:{callbacks:{
                    afterLabel: ctx => {
                        const u = ctx.label;
                        const d = reportData.sessionData[u];
                        if (!d) return '';
                        const format = (val) => (typeof val === 'number' && isFinite(val)) ? val.toFixed(2) : '0.00';
                        return [
                            `Min: ${format(d.min)}`,
                            `Q1: ${format(d.q1)}`,
                            `Méd: ${format(d.median)}`,
                            `Q3: ${format(d.q3)}`,
                            `Max: ${format(d.max)}`
                        ];
                    }
                }}},scales:{y:{beginAtZero:true,title:{display:true,text:'Durée (minutes)'}}}}});
            }
            
            const userSessionTableBody = document.getElementById('userSessionStatsTable').tBodies[0];
            userSessionTableBody.innerHTML = ''; 
            (reportData.userSessionStats || []).forEach(s=>{
                const r=userSessionTableBody.insertRow();
                r.innerHTML = `<td>${s.user}</td><td>${s.sessions}</td><td>${s.avg.toFixed(2)}</td><td>${s.median.toFixed(2)}</td><td>${s.total.toFixed(2)}</td><td>${(s.total / 60).toFixed(2)}</td><td>${s.min.toFixed(2)}</td><td>${s.max.toFixed(2)}</td>`;
            });

            if(reportData.courseNames?.length > 0){
                courseActivityChartInstance = new Chart(document.getElementById('courseActivityChart'),{type:'bar',data:{labels:reportData.truncatedCourseNames,datasets:[{label:'Événements',data:reportData.courseEvents,backgroundColor:getColors(reportData.courseNames.length)}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false}, tooltip:{callbacks:{title: (tooltipItems) => reportData.courseNames[tooltipItems[0].dataIndex]}}},scales:{x:{beginAtZero:true}}}});
                courseTimeChartInstance = new Chart(document.getElementById('courseTimeChart'),{type:'bar',data:{labels:reportData.truncatedCourseNames,datasets:[{label:'Temps (min)',data:reportData.courseTimes,backgroundColor:getColors(reportData.courseNames.length)}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false}, tooltip:{callbacks:{title: (tooltipItems) => reportData.courseNames[tooltipItems[0].dataIndex]}}},scales:{x:{beginAtZero:true}}}});
                courseAvgSessionChartInstance = new Chart(document.getElementById('courseAvgSessionChart'),{type:'bar',data:{labels:reportData.truncatedCourseNames,datasets:[{label:'Moy. Session (min)',data:reportData.courseAvgDurations,backgroundColor:getColors(reportData.courseNames.length)}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}, tooltip:{callbacks:{title: (tooltipItems) => reportData.courseNames[tooltipItems[0].dataIndex]}}},scales:{y:{beginAtZero:true}}}});
            }
            if(reportData.componentNames?.length > 0){
                componentChartInstance = new Chart(document.getElementById('componentChart'),{type:'pie',data:{labels:reportData.componentNames,datasets:[{data:reportData.componentCounts,backgroundColor:getColors(reportData.componentNames.length)}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right'}}}});
            }

            if(reportData.weekdays?.length > 0) {
                weekdayActivityChartInstance = new Chart(document.getElementById('weekdayActivityChart'),{type:'bar',data:{labels:reportData.weekdays,datasets:[{label:'Événements',data:reportData.weekdayCounts,backgroundColor:getColors(reportData.weekdays.length)}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
            }
            if(reportData.hours?.length > 0) {
                 hourlyActivityChartInstance = new Chart(document.getElementById('hourlyActivityChart'),{type:'bar',data:{labels:reportData.hours,datasets:[{label:'Événements',data:reportData.hourlyCounts,backgroundColor:getColors(reportData.hours.length)}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
            }
            
            const monthlyTimeChartContainer = document.getElementById('monthlyTimeChartContainer');
            if(reportData.monthlyTimeLabels?.length > 1) {
                monthlyTimeChartContainer.classList.remove('hidden');
                monthlyTimeChartInstance = new Chart(document.getElementById('monthlyTimeChart'), {type:'line', data:{labels:reportData.monthlyTimeLabels, datasets:[{label:'Heures de connexion', data:reportData.monthlyTimeData, fill:true, borderColor: 'rgb(75, 192, 192)', tension:0.1}]}, options:{responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true, title:{display:true, text:'Heures'}}}}});
            } else {
                monthlyTimeChartContainer.classList.add('hidden');
            }

            const genDate = new Date();
            document.getElementById('reportGeneratedDate').textContent = `Rapport généré le ${genDate.toLocaleDateString('fr-FR')} à ${genDate.toLocaleTimeString('fr-FR')} | ${reportData.summary?.reportPeriod || ''}`;
        }
        
        function applyAndProcessData() {
            const getSelected = (type) => Array.from(document.querySelectorAll(`#${type}FilterContainer input[type=checkbox]:checked:not(#${type}FilterAll)`)).map(cb => cb.value);
            const selectedMonths = getSelected('month');
            const selectedLearners = getSelected('learner');
            const selectedCourses = getSelected('course');

            currentFilteredData = allUploadedData.filter(item => {
                const monthMatch = document.getElementById('monthFilterAll').checked || (item.parsedDate && selectedMonths.includes(`${frenchMonths[item.parsedDate.getMonth()]} ${item.parsedDate.getFullYear()}`));
                const learnerMatch = document.getElementById('learnerFilterAll').checked || selectedLearners.includes(item["Nom complet de l’utilisateur"]);
                const courseName = item["Contexte de l’événement"]?.startsWith("Cours: ") ? item["Contexte de l’événement"].substring(7).trim() : null;
                const courseMatch = document.getElementById('courseFilterAll').checked || (courseName && selectedCourses.includes(courseName));
                return monthMatch && learnerMatch && courseMatch;
            });
            processAndAnalyzeData(currentFilteredData);
        }

        function processAndAnalyzeData(dataToProcess) { 
            if (dataToProcess.length === 0) {
                showNotification("Aucune donnée ne correspond aux filtres actuels.", "warning");
                destroyAllCharts();
                const summaryIds = { totalEvents: '0', activeUsers: '0', avgSessionDuration: '0 min', peakHour: 'N/A', peakDay: 'N/A', mostActiveCourse: 'N/A' };
                Object.keys(summaryIds).forEach(id => { document.getElementById(id).textContent = summaryIds[id]; });
                return;
            }

            const users = [...new Set(dataToProcess.map(item => item["Nom complet de l’utilisateur"]))].filter(Boolean);
            const courses = [...new Set(dataToProcess.map(item => (item["Contexte de l’événement"]?.startsWith("Cours: ") ? item["Contexte de l’événement"].substring(7).trim() : null)))].filter(Boolean);

            const eventCountsByUser = users.map(user => ({user, count: dataToProcess.filter(i=>i["Nom complet de l’utilisateur"]===user).length})).sort((a,b)=>b.count-a.count);
            const sessionStatsByUser = calculateSessionStats(dataToProcess, 'Nom complet de l’utilisateur');
            
            const userNamesForCharts = eventCountsByUser.map(d => d.user);
            const engagementScoresOrdered = userNamesForCharts.map(user => {
                const d = dataToProcess.filter(i=>i["Nom complet de l’utilisateur"]===user);
                const uD = new Set(d.map(i=>i.parsedDate?.toDateString())).size;
                const divF = new Set(d.map(i=>i["Nom de l’événement"])).size;
                const rawScore = (Math.log10(d.length+1)*(uD+1)*(sessionStatsByUser[user]?.totalDuration||0.1)*(divF/5))/5000;
                return Math.min(1, Math.max(0, rawScore)); 
            });
            const totalTimesOrdered = userNamesForCharts.map(u => sessionStatsByUser[u]?.totalDuration || 0);
            const userSessionStatsForTable = userNamesForCharts.map(user => {
                const s=sessionStatsByUser[user];
                return {user,sessions:s?.count||0,avg:s?.avgDuration||0,median:s?.medianDuration||0,total:s?.totalDuration||0,min:s?.minDuration||0,max:s?.maxDuration||0};
            }).sort((a,b)=>b.total-a.total);
            
            const sessionDataForChart = {};
            userNamesForCharts.forEach(user => {
                const s = sessionStatsByUser[user];
                sessionDataForChart[user] = s ? {
                    median: s.medianDuration,
                    q1: s.q1Duration,
                    q3: s.q3Duration,
                    min: s.minDuration,
                    max: s.maxDuration
                } : { median: 0, q1: 0, q3: 0, min: 0, max: 0 };
            });

            const eventCountsByCourse = courses.map(c=>({course:c,count:dataToProcess.filter(i=>i["Contexte de l’événement"]?.includes(c)).length})).sort((a,b)=>b.count-a.count);
            const courseNamesForCharts = eventCountsByCourse.map(d => d.course);
            const truncatedCourseNames = courseNamesForCharts.map(name => truncateLabel(name, 35));
            
            const courseSessionBreakdown = {};
            courseNamesForCharts.forEach(cN => {
                const cE = dataToProcess.filter(i=>i["Contexte de l’événement"]?.includes(cN));
                courseSessionBreakdown[cN] = calculateSessionStats(cE,'Nom complet de l’utilisateur',true);
            });

            const courseTimes = courseNamesForCharts.map(cN => Object.values(courseSessionBreakdown[cN]||{}).reduce((s,uS)=>s+uS.totalDuration,0));
            const courseAvgDurations = courseNamesForCharts.map(cN => {
                const statsForCourse = Object.values(courseSessionBreakdown[cN]||{});
                const totalDuration = statsForCourse.reduce((sum,st)=>sum+st.totalDuration,0); 
                const totalSessions = statsForCourse.reduce((sum,st)=>sum+st.count,0);
                return totalSessions>0 ? totalDuration/totalSessions : 0;
            });
             const courseSessionStatsForTable = courseNamesForCharts.map(cN => {
                const statsForCourse = Object.values(courseSessionBreakdown[cN]||{});
                return {course:cN,sessions:statsForCourse.reduce((sum,st)=>sum+st.count,0),avg:courseAvgDurations[courseNamesForCharts.indexOf(cN)],total:courseTimes[courseNamesForCharts.indexOf(cN)],users:new Set(statsForCourse.map(st=>st.name)).size};
            }).sort((a,b)=>b.total-a.total);

            const componentCounts = dataToProcess.reduce((acc, item) => {
                const comp = item['Composant'] || 'Non défini';
                acc[comp] = (acc[comp] || 0) + 1;
                return acc;
            }, {});
            const sortedComponents = Object.entries(componentCounts).sort(([,a],[,b]) => b-a);
            const topComponents = sortedComponents.slice(0, 7);
            const otherCount = sortedComponents.slice(7).reduce((acc, [, count]) => acc + count, 0);
            if (otherCount > 0) topComponents.push(['Autres', otherCount]);

            const weekdayLabels = ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'];
            const weekdayCounts = Array(7).fill(0);
            dataToProcess.forEach(i=>{if(i.parsedDate)weekdayCounts[i.parsedDate.getDay()===0?6:i.parsedDate.getDay()-1]++;});
            const hourlyLabels = Array.from({length:24},(_,i)=>`${i}h`);
            const hourlyCounts = Array(24).fill(0);
            dataToProcess.forEach(i=>{if(i.parsedDate)hourlyCounts[i.parsedDate.getHours()]++;});
            
            const monthlyTime = {};
            const uniqueMonthsInSelection = [...new Set(dataToProcess.map(d => d.parsedDate ? `${frenchMonths[d.parsedDate.getMonth()]} ${d.parsedDate.getFullYear()}` : null).filter(Boolean))];
            if (uniqueMonthsInSelection.length > 1) {
                dataToProcess.forEach(item => {
                    if(!item.parsedDate) return;
                    const monthKey = `${frenchMonths[item.parsedDate.getMonth()]} ${item.parsedDate.getFullYear()}`;
                    if(!monthlyTime[monthKey]) monthlyTime[monthKey] = 0;
                }); // init all selected months
                Object.values(sessionStatsByUser).forEach(userStats => {
                    userStats.allDurationsWithTime.forEach(session => {
                        const monthKey = `${frenchMonths[session.date.getMonth()]} ${session.date.getFullYear()}`;
                        if(monthlyTime.hasOwnProperty(monthKey)) {
                            monthlyTime[monthKey] += session.duration;
                        }
                    });
                });
            }
            const sortedMonthlyTime = Object.entries(monthlyTime).sort((a,b) => new Date(a[0].split(' ')[1], frenchMonths.indexOf(a[0].split(' ')[0])) - new Date(b[0].split(' ')[1], frenchMonths.indexOf(b[0].split(' ')[0])));

            const unparsableDates = allUploadedData.filter(item => item["Heure"] && !item.parsedDate).map(item => item["Heure"]);

            renderReport({
                userNames: userNamesForCharts, eventCounts: eventCountsByUser.map(d => d.count), totalTimes: totalTimesOrdered, engagementScores: engagementScoresOrdered,
                sessionData: sessionDataForChart, userSessionStats: userSessionStatsForTable,
                courseNames: courseNamesForCharts, truncatedCourseNames, courseEvents: eventCountsByCourse.map(d=>d.count), courseTimes, courseAvgDurations,
                componentNames: topComponents.map(d => d[0]), componentCounts: topComponents.map(d => d[1]),
                weekdays: weekdayLabels, weekdayCounts, hours: hourlyLabels, hourlyCounts,
                monthlyTimeLabels: sortedMonthlyTime.map(d => d[0]), monthlyTimeData: sortedMonthlyTime.map(d => (d[1]/60).toFixed(2)),
                summary: generateSummary(dataToProcess, eventCountsByUser, sessionStatsByUser, weekdayCounts, weekdayLabels, hourlyCounts, hourlyLabels, eventCountsByCourse, unparsableDates),
                insights: generateDynamicInsights(dataToProcess, eventCountsByUser, sessionStatsByUser, courseSessionStatsForTable, weekdayCounts, hourlyCounts)
            });
        }

        function generateSummary(data, eventCountsByUser, sessionStatsByUser, weekdayCounts, weekdayLabels, hourlyCounts, hourlyLabels, eventCountsByCourse, unparsableDates) { 
            const summary = {};
            summary.totalEvents = data.length.toLocaleString('fr-FR');
            summary.activeUsers = eventCountsByUser.length.toLocaleString('fr-FR');
            const allSessDurs = Object.values(sessionStatsByUser).flatMap(uS=>uS.allDurations);
            if(allSessDurs.length>0){
                summary.avgSessionDuration=`${(allSessDurs.reduce((a,b)=>a+b,0)/allSessDurs.length).toFixed(1)} min`;
            }
            const pkHrIdx=hourlyCounts.indexOf(Math.max(...hourlyCounts)); summary.peakHour=hourlyLabels[pkHrIdx]||'N/A';
            const pkDayIdx=weekdayCounts.indexOf(Math.max(...weekdayCounts)); summary.peakDay=weekdayLabels[pkDayIdx]||'N/A';
            if(eventCountsByCourse.length>0) summary.mostActiveCourse=eventCountsByCourse[0].course.substring(0,30)+(eventCountsByCourse[0].course.length>30?"...":"");
            
            const dates=data.map(d=>d.parsedDate).filter(Boolean);
            if(dates.length>0){const minD=new Date(Math.min(...dates));const maxD=new Date(Math.max(...dates));summary.reportPeriod=`Période: ${minD.toLocaleDateString('fr-FR')} - ${maxD.toLocaleDateString('fr-FR')}`;}
            
            if (unparsableDates.length > 0) {
                summary.unparsableDatesWarning = `<span class="font-medium">Avertissement :</span> ${unparsableDates.length} date(s) n'ont pas pu être interprétée(s).`;
            }
            return summary;
        }

        function generateDynamicInsights(data, eventCountsByUser, sessionStatsByUser, courseSessionStats, weekdayCounts, hourlyCounts) {
            const insights = { mainInsights: [], recommendations: [] };
            if (!data || data.length === 0) {
                insights.mainInsights.push("Aucune donnée à analyser pour les filtres actuels.");
                return insights;
            }

            // --- Principaux Constats ---
            if (eventCountsByUser.length > 0) {
                const totalEvents = data.length;
                const topUser = eventCountsByUser[0];
                const topUserPercentage = ((topUser.count / totalEvents) * 100).toFixed(0);
                insights.mainInsights.push(`<span class="font-medium">Utilisateur le plus actif :</span> ${topUser.user} a généré ${topUserPercentage}% de l'activité totale.`);
            }

            const allSessionDurs = Object.values(sessionStatsByUser).flatMap(uS => uS.allDurations);
            if (allSessionDurs.length > 0) {
                const globalMedSess = [...allSessionDurs].sort((a, b) => a - b)[Math.floor(allSessionDurs.length / 2)];
                insights.mainInsights.push(`<span class="font-medium">Durée des sessions :</span> La durée médiane d'une session est de <strong>${globalMedSess.toFixed(1)} min</strong>.`);
                if (globalMedSess < 15) {
                    insights.recommendations.push("Les sessions sont courtes. Envisagez de créer des micro-contenus ou des activités plus brèves pour maintenir l'engagement.");
                } else if (globalMedSess > 45) {
                    insights.recommendations.push("Les sessions sont longues, ce qui indique un fort engagement. Assurez-vous que les contenus longs sont bien structurés pour faciliter la navigation.");
                }
            }

            const weekdayLabels = ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'];
            const pkDayIdx = weekdayCounts.indexOf(Math.max(...weekdayCounts));
            const peakDay = weekdayLabels[pkDayIdx];
            const pkHrIdx = hourlyCounts.indexOf(Math.max(...hourlyCounts));
            const peakHour = `${pkHrIdx}h - ${pkHrIdx + 1}h`;
            insights.mainInsights.push(`<span class="font-medium">Pic d'activité :</span> L'engagement est le plus fort le <strong>${peakDay}</strong>, particulièrement entre <strong>${peakHour}</strong>.`);
            insights.recommendations.push(`Planifiez les communications et les nouvelles activités autour du pic d'activité (le ${peakDay} vers ${peakHour}) pour maximiser la visibilité.`);

            if (courseSessionStats.length > 0) {
                const topCourseByTime = [...courseSessionStats].sort((a,b) => b.total - a.total)[0];
                if (topCourseByTime) {
                    insights.mainInsights.push(`<span class="font-medium">Contenu le plus consulté :</span> Le cours "<strong>${truncateLabel(topCourseByTime.course, 30)}</strong>" est celui où les apprenants passent le plus de temps.`);
                    insights.recommendations.push(`Analysez les éléments pédagogiques du cours "<strong>${truncateLabel(topCourseByTime.course, 20)}</strong>" pour identifier les facteurs de succès et les répliquer.`);
                }
            }

            const engagementScores = eventCountsByUser.map(u => {
                const d = allUploadedData.filter(i => i["Nom complet de l’utilisateur"] === u.user);
                const uD = new Set(d.map(i => i.parsedDate?.toDateString())).size;
                const divF = new Set(d.map(i => i["Nom de l’événement"])).size;
                const rawScore = (Math.log10(u.count + 1) * (uD + 1) * (sessionStatsByUser[u.user]?.totalDuration || 0.1) * (divF / 5)) / 5000;
                return { user: u.user, score: Math.min(1, Math.max(0, rawScore)) };
            });

            const lowEngagementUsers = engagementScores.filter(u => u.score < 0.1);
            if (lowEngagementUsers.length > 1) {
                insights.mainInsights.push(`<span class="font-medium">Engagement faible :</span> <strong>${lowEngagementUsers.length} utilisateurs</strong> ont un score d'engagement très bas.`);
                insights.recommendations.push("Identifiez les utilisateurs avec une faible activité pour leur proposer un soutien personnalisé et comprendre leurs freins.");
            }

            if (insights.mainInsights.length === 0) {
                 insights.mainInsights.push("Aucun constat majeur pour cette sélection de données.");
            }
             if (insights.recommendations.length === 0) {
                insights.recommendations.push("L'activité semble équilibrée. Continuez à suivre l'engagement pour détecter de nouvelles tendances.");
            }

            return insights;
        }


        function calculateSessionStats(data, groupByField) {
            const grouped = data.reduce((acc, item) => {
                const key = item[groupByField];
                if (!key || !item.parsedDate) return acc;
                if (!acc[key]) acc[key] = [];
                acc[key].push(item.parsedDate);
                return acc;
            }, {});

            const sessionStats = {};
            for (const key in grouped) {
                const events = grouped[key].sort((a,b)=>a-b);
                if (events.length === 0) continue;
                const sessions = []; let start = events[0];
                for (let i=1; i<events.length; i++) {
                    if ((events[i].getTime()-events[i-1].getTime()) > 30*60*1000) {
                        sessions.push({duration: (events[i-1].getTime()-start.getTime())/(60*1000), date: start}); 
                        start=events[i];
                    }
                }
                sessions.push({duration: (events[events.length-1].getTime()-start.getTime())/(60*1000), date: start});
                const valid = sessions.filter(d=>d.duration>=0); if(valid.length === 0) continue;
                const durations = valid.map(s => s.duration);
                const total=durations.reduce((a,v)=>a+v,0);
                const srt=durations.sort((a,b)=>a-b);
                sessionStats[key] = {name:key,count:valid.length,totalDuration:total,avgDuration:total/valid.length,medianDuration:srt[Math.floor(srt.length/2)]||0, q1Duration: srt[Math.floor(srt.length/4)]||0, q3Duration: srt[Math.floor((3*srt.length)/4)]||0, minDuration:srt[0]||0,maxDuration:srt[srt.length-1]||0,allDurations:srt, allDurationsWithTime: valid};
            }
            return sessionStats;
        }
        
        function populateFilters(data) {
            const monthFilterCont = document.getElementById('monthFilterContainer');
            const learnerFilterCont = document.getElementById('learnerFilterContainer');
            const courseFilterCont = document.getElementById('courseFilterContainer');
            
            [monthFilterCont, learnerFilterCont, courseFilterCont].forEach(cont => {
                const type = cont.id.replace('FilterContainer', '');
                const label = cont.previousElementSibling.textContent.replace(':', '');
                cont.innerHTML = `<div class="mb-1"><input type="checkbox" id="${type}FilterAll" checked class="mr-1"><label for="${type}FilterAll" class="cursor-pointer">Tous</label></div>`;
            });

            const monthsSet = new Set(), learnersSet = new Set(), coursesSet = new Set();
            data.forEach(item => {
                if (item.parsedDate) monthsSet.add(`${frenchMonths[item.parsedDate.getMonth()]} ${item.parsedDate.getFullYear()}`);
                if (item["Nom complet de l’utilisateur"]) learnersSet.add(item["Nom complet de l’utilisateur"]);
                const ctx = item["Contexte de l’événement"];
                if (ctx?.startsWith("Cours: ")) coursesSet.add(ctx.substring(7).trim());
            });
            
            const sortedMonths = Array.from(monthsSet).sort((a,b) => new Date(a.split(' ')[1], frenchMonths.indexOf(a.split(' ')[0])) - new Date(b.split(' ')[1], frenchMonths.indexOf(b.split(' ')[0])));
            sortedMonths.forEach(m => addCheckboxOption(monthFilterCont, m));
            Array.from(learnersSet).sort().forEach(l => addCheckboxOption(learnerFilterCont, l));
            Array.from(coursesSet).sort().forEach(c => addCheckboxOption(courseFilterCont, c));
            
            document.getElementById('filterSection').classList.remove('hidden');
        }

        function addCheckboxOption(container, value) {
            const type = container.id.replace('FilterContainer','');
            const id = `${type}-${value.replace(/\s+/g,'-').replace(/[^\w-]/g, '')}`;
            const div = document.createElement('div');
            div.innerHTML = `<input type="checkbox" id="${id}" value="${value}" checked class="mr-1"><label for="${id}" class="cursor-pointer">${value}</label>`;
            container.appendChild(div);
        }

        function updateDependentFilters() {
            const getSelected = (type) => Array.from(document.querySelectorAll(`#${type}FilterContainer input[type=checkbox]:checked:not(#${type}FilterAll)`)).map(cb => cb.value);
            
            const allMonthsChecked = document.getElementById('monthFilterAll').checked;
            const selectedMonths = getSelected('month');
            
            const allCoursesChecked = document.getElementById('courseFilterAll').checked;
            const selectedCourses = getSelected('course');

            const relevantData = allUploadedData.filter(item => {
                const monthMatch = allMonthsChecked || (item.parsedDate && selectedMonths.includes(`${frenchMonths[item.parsedDate.getMonth()]} ${item.parsedDate.getFullYear()}`));
                const courseName = item["Contexte de l’événement"]?.startsWith("Cours: ") ? item["Contexte de l’événement"].substring(7).trim() : null;
                const courseMatch = allCoursesChecked || (courseName && selectedCourses.includes(courseName));
                return monthMatch && courseMatch;
            });

            const relevantLearners = [...new Set(relevantData.map(item => item["Nom complet de l’utilisateur"]).filter(Boolean))].sort();
            
            const learnerContainer = document.getElementById('learnerFilterContainer');
            const allLearnerCheckbox = learnerContainer.querySelector('input[type=checkbox][id$=FilterAll]');
            const wasAllChecked = allLearnerCheckbox.checked;
            
            const allLearnerCheckboxHTML = learnerContainer.firstElementChild.outerHTML;
            learnerContainer.innerHTML = allLearnerCheckboxHTML;
            
            relevantLearners.forEach(learner => addCheckboxOption(learnerContainer, learner));
            
            learnerContainer.querySelector('input[type=checkbox][id$=FilterAll]').checked = wasAllChecked;
        }
        
        function handleFile(file) {
            if (!file || !file.type.match('text/csv')) {
                showNotification("Veuillez sélectionner un fichier CSV valide.", "warning"); return;
            }
            currentFileName = file.name;
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('reportContent').classList.add('hidden'); 
            destroyAllCharts(); 

            Papa.parse(file, {
                header: true, skipEmptyLines: true, encoding: "UTF-8",
                complete: results => {
                    document.getElementById('loadingIndicator').classList.add('hidden');
                    if (results.errors.length > 0) console.warn("Erreurs de parsing CSV:", results.errors);
                    
                    allUploadedData = results.data.filter(row => row["Heure"]).map(row => ({...row, parsedDate: parseFrenchDate(row["Heure"]) }));
                    
                    if (allUploadedData.length === 0) {
                        showNotification(`Le fichier CSV "${file.name}" ne contient pas de données exploitables.`, "error", false); return;
                    }
                    
                    populateFilters(allUploadedData); 
                    applyAndProcessData(); 
                    showNotification(`Fichier "${currentFileName}" analysé (${allUploadedData.length} lignes traitées).`, "success");
                },
                error: e => { 
                    document.getElementById('loadingIndicator').classList.add('hidden');
                    showNotification("Erreur de lecture du fichier CSV.", "error", false);
                }
            });
        }

        async function exportPdf() {
            const reportContent = document.getElementById('reportContent');
            if (reportContent.classList.contains('hidden') || currentFilteredData.length === 0) {
                showNotification("Aucun rapport à exporter.", "warning"); return;
            }
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.textContent = 'Génération du PDF...';
            loadingIndicator.classList.remove('hidden');

            const isDarkMode = document.documentElement.classList.contains('dark');
            
            try {
                if (isDarkMode) {
                    document.documentElement.classList.remove('dark');
                    await new Promise(resolve => requestAnimationFrame(() => setTimeout(resolve, 50)));
                }

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const margin = 10;
                let y = margin;

                const sections = reportContent.querySelectorAll('section.card');
                for (const section of sections) {
                     if (section.offsetParent === null) continue; // Skip hidden sections
                    const canvas = await html2canvas(section, {
                        scale: 2, 
                        backgroundColor: '#ffffff',
                        useCORS: true,
                        logging: false
                    });
                    const imgData = canvas.toDataURL('image/png', 1.0);
                    const imgWidth = pdfWidth - (margin * 2);
                    const imgHeight = canvas.height * imgWidth / canvas.width;

                    if (y + imgHeight > pdf.internal.pageSize.getHeight() - margin) {
                        pdf.addPage();
                        y = margin;
                    }
                    pdf.addImage(imgData, 'PNG', margin, y, imgWidth, imgHeight);
                    y += imgHeight + 5;
                }

                pdf.save(`rapport_moodle_${new Date().toISOString().slice(0,10)}.pdf`);

            } catch (error) {
                console.error("Erreur lors de la génération du PDF:", error);
                showNotification("Une erreur est survenue lors de la génération du PDF.", "error");
            } finally {
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                }
                loadingIndicator.classList.add('hidden');
                loadingIndicator.textContent = 'Analyse en cours...';
            }
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('reportGeneratedDate').textContent = `Prêt à analyser.`;
            
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
            themeToggleBtn.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            });

            // Drag and Drop listeners
            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.classList.remove('dragover'); });
            dropZone.addEventListener('drop', e => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
            });
            document.getElementById('csvFile').addEventListener('change', e => handleFile(e.target.files[0]));
            
            // Filter listeners
            const filterSection = document.getElementById('filterSection');
            filterSection.addEventListener('change', (e) => {
                const targetCheckbox = e.target;
                if (targetCheckbox.type !== 'checkbox') return;

                const container = targetCheckbox.closest('.filter-checkbox-container');
                if (!container) return;

                const type = container.id.replace('FilterContainer', '');
                const allCheckbox = document.getElementById(`${type}FilterAll`);
                const itemCheckboxes = container.querySelectorAll(`input[type=checkbox]:not(#${type}FilterAll)`);

                if (targetCheckbox.id.endsWith('FilterAll')) {
                    itemCheckboxes.forEach(cb => {
                        cb.checked = allCheckbox.checked;
                    });
                } 
                else {
                    const checkedCount = Array.from(itemCheckboxes).filter(cb => cb.checked).length;
                    if (checkedCount === itemCheckboxes.length) {
                        allCheckbox.checked = true;
                        allCheckbox.indeterminate = false;
                    } else if (checkedCount === 0) {
                        allCheckbox.checked = false;
                        allCheckbox.indeterminate = false;
                    } else {
                        allCheckbox.checked = false;
                        allCheckbox.indeterminate = true;
                    }
                }

                if (type === 'month' || type === 'course') {
                    updateDependentFilters();
                }
                
                applyAndProcessData();
            });
            
            document.getElementById('resetFiltersButton').addEventListener('click', () => {
                populateFilters(allUploadedData);
                applyAndProcessData();
                showNotification("Filtres réinitialisés.", "success");
            });

            // Export listeners
            document.getElementById('exportJsonButton').addEventListener('click', () => {
                if(currentFilteredData.length === 0) {
                    showNotification("Aucune donnée à exporter.", "warning");
                    return;
                }
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(currentFilteredData, (key, value) => key === 'parsedDate' ? undefined : value, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `export_moodle_${new Date().toISOString().slice(0,10)}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                showNotification("Données JSON exportées.", "success");
            });

            document.getElementById('exportPdfButton').addEventListener('click', exportPdf);

            // Scroll to top button
            const scrollToTopBtn = document.getElementById('scrollToTopBtn');
            window.onscroll = () => {
                if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) scrollToTopBtn.classList.add('show');
                else scrollToTopBtn.classList.remove('show');
            };
            scrollToTopBtn.addEventListener('click', () => window.scrollTo({top: 0, behavior: 'smooth'}));
        });
    </script>
</body>
</html>
